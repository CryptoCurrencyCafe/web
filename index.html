<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Cryptocurrency Cafe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="David Evans">
    <link rel="icon" type="image/png" href="http://www.rust-class.org/static/images/logo.png" />  
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>

    <!-- Le styles -->
    <link rel="stylesheet" href="http://bitcoin-class.org/theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
     .about {
        font-size: 8pt;
        font-color: "gray";
     }
    </style>
    <link href="http://bitcoin-class.org/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="http://bitcoin-class.org/theme/css/font-awesome.css" rel="stylesheet">

    <link href="http://bitcoin-class.org/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="http://bitcoin-class.org/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://bitcoin-class.org/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="http://bitcoin-class.org/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="http://bitcoin-class.org/theme/images/apple-touch-icon-114x114.png">

    <link href="http://bitcoin-class.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cryptocurrency Cafe ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="http://bitcoin-class.org/index.html">Cryptocurrency Cafe </a>
          <div class="nav-collapse">
            <ul class="nav">
                  <li><a href="/pages/forum.html"><b>Forum</b></a></li>
                  <li><a href="/">&middot</a></li>
                  <li><a href="/pages/ps0.html">PS0</a></li>
                  <li><a href="/pages/project1.html"><b>Project 1</b></a></li>
                  <li><a href="/">&middot</a></li>
                  <li><a href="https://www.google.com/calendar/embed?src=rmjagdrnmu3a9h2q5199lg4t28%40group.calendar.google.com&ctz=America/New_York""><b>Calendar</b></a></li>
                  <li><a href="/pages/resources.html"><b>Resources</b></a></li>

                          <ul class="nav pull-right">
                                <li><a href="http://bitcoin-class.org/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
	<section id="sidebar">
          <p>
	    <a href="http://www.virginia.edu"><b>University&nbsp;of&nbsp;Virginia</b></a>
	    Spring&nbsp;2015<br>
	    <a href="http://www.cs.virginia.edu/evans/">David&nbsp;Evans</a>
	  </p>
	  <p>
	  <div class="separator"></div>
<h3>
<a href="https://www.google.com/calendar/embed?src=rmjagdrnmu3a9h2q5199lg4t28%40group.calendar.google.com&ctz=America/New_York">Calendar</a>
</h3>
<h3>
<a href="./pages/forum.html">Forum</a>
</h3>
<h3><a href="./pages/syllabus.html">Syllabus</a>
</h3>

	  <div class="separator"></div>
	  <h3>Projects</h3>
<ul>
<li> <a href="./pages/ps0.html">0: Registration</a>
<li> <a href="./pages/project1.html">1: Bitcoin Transactions</a>
</ul>

	  <div class="separator"></div>
	  <h3><A href="./pages/classes.html">Classes</a></h3>
<ul>
<li> &nbsp;<a href="./class-1-why-are-these-buildings-burning-down.html">1: Burning Down</a>
<li> &nbsp;<a href="./class-2-cryptography.html">2: Cryptography</a>
<li> &nbsp;<a href="./class-3-elliptic-curves.html">3: Elliptic Curves</a>
<li> &nbsp;<a href="./class-4-verifiably-random.html">4: Verifiably Random</a>
<li> &nbsp;<a href="./class-5-digicash.html">5: DigiCash</a>
<li> &nbsp;<a href="./class-6-proofs-of-work.html">6: Proofs of Work</a>
<li> &nbsp;<a href="./class-7-merkle-trees.html">7: Merkle Trees</a>
</ul>

<p><br></br></p>
<p><br></br></p>

<ul>
<li>
<a href="./pages/using-materials.html">Using These Materials</a>
</ul>

	</section>
</section>


<section id="mainbody">


<!--
<div id="calendar">
<iframe src="https://www.google.com/calendar/embed?showTitle=0&amp;showNav=0&amp;showDate=0&amp;showPrint=0&amp;showCalendars=0&amp;showTz=0&amp;mode=AGENDA&amp;height=600&amp;wkst=2&amp;bgcolor=%23ffffff&amp;src=7ibtm6lnt88vl00h7a0e8n0bc4%40group.calendar.google.com&amp;color=%23711616&amp;ctz=America%2FNew_York" style=" border:solid 1px #777 " width="200" height="600" frameborder="0" scrolling="no">
</iframe>
</div>
-->


        <div class="article">
 
                   <h1><a href="http://bitcoin-class.org/starting-project-2.html">Starting Project 2</a></h1>
                   <div class="well small"><footer class="post-info">
<span class="quietlabel">Posted: </span>
<abbr class="published" title="2015-02-05T00:00:00-05:00">
    Thu 05 February 2015
</abbr>
<!-- <span class="quietlabel">by</span>
<a href="http://bitcoin-class.org/author/david-evans.html">David Evans</a>
-->
<!--
<span class="label">Category</span>
<a href="http://bitcoin-class.org/category/announcements.html"><i class="icon-folder-open"></i>announcements</a>.
-->

<!--
-->
</footer><!-- /.post-info --></div>
                   <div class="content"><p><strong>Project 1.</strong> You should have received your Project 1 grade as a
  transfer to your vanity address (on a 100,000 satoshi scale, so 0.001
  BTC is full credit).  You should be able to see this in the blockchain
  (e.g., by searching for your vanity address).  Note that this is
  different from the address you used to create your initial wallet, so
  you won't see it in your wallet unless you load the keys for your
  vanity address into your wallet (see
  <a href="https://multibit.org/en/help/v0.5/help_importingPrivateKeys.html">https://multibit.org/en/help/v0.5/help_importingPrivateKeys.html</a>
  for how to import your vanity address private key into MultiBit).</p>
<p><strong>Geting started on Project 2.</strong> For project 2, you'll be implementing
  and running a miner for a new cryptocurrency,
  <a href="https://github.com/PointCoin/pointcoind">PointCoin</a>.  We'll talk more
  about this in class Monday and post a more detailed project
  descruption soon, but you should get started by setting up your
  pointcoind node before class Monday.  </p>
<p>Directions for getting your
  pointcoind node setup on a free EC2 instance are here: <a href="https://github.com/PointCoin/pointcoind/wiki/Installing-PointCoin-on-AWS">Installing
  PointCoin on
  AWS</a>.</p>
<p>If you get stuck, we'll have time in class Monday to help, but you
  should get as far as you can on your own before class Monday.  Feel
  free to also post coments and questions here.</p></div>
<div class="commentstag"><a href="http://bitcoin-class.org/starting-project-2.html#disqus_thread" data-disqus-identifier="starting-project-2">Comments</a></div>
                   <hr />
        </div>

        <div class="article">
 
                   <h1><a href="http://bitcoin-class.org/class-7-merkle-trees.html">Class 7: Merkle Trees</a></h1>
                   <div class="well small"><footer class="post-info">
<span class="quietlabel">Posted: </span>
<abbr class="published" title="2015-02-04T00:00:00-05:00">
    Wed 04 February 2015
</abbr>
<!-- <span class="quietlabel">by</span>
<a href="http://bitcoin-class.org/author/david-evans.html">David Evans</a>
-->
<!--
<span class="label">Category</span>
<a href="http://bitcoin-class.org/category/class7.html"><i class="icon-folder-open"></i>class7</a>.
-->

<!--
-->
</footer><!-- /.post-info --></div>
                   <div class="content"><p><div class="phighlight">
   <a href="http://bitcoin-class.org/classes/class7/class7.pdf">PDF version for printing</a>
   </div></p>
<h2>Schedule</h2>
<p><div class="todo"> </p>
<ul>
<li>
<p>If you didn’t get full credit for Project 1 because of failure to post
  something interesting, you can (and should!) redeem yourself and earn
  full credit by <strong>posting an interesting comment by Thursday</strong>.  It can
  be on (1) Discussion questions from Project 1 (2) notes from classes,
  or (3) general forum.</p>
</li>
<li>
<p><strong>Quiz</strong>: We'll have a short, closed resources quiz in class on
    <strong>Wednesday, 11 February</strong>.  The point of the quiz is to see how
    well people are understanding the core ideas we've covered so far
    (including today).</p>
</li>
<li>
<p><strong>Read</strong> (by Monday): <a href="https://github.com/aantonop/bitcoinbook/blob/develop/ch06.asciidoc"><em>Chapter 6: The Bitcoin
Network</em></a>,
<a href="https://github.com/aantonop/bitcoinbook/blob/develop/ch07.asciidoc"><em>Chapter 7: The
Blockchain</em></a>
from Andreas Antonopoulos' book.</p>
</li>
<li>
<p>I am away the rest of this week, so will not have office hours on
  Thursday.  (I am, of course, still available by email and course web
  site.)</p>
</li>
<li>
<p>In Monday's class, Nick and Alex will explain what is provided and
what you need to do for project 2.  You should at least set up your node
for project 2 before class Monday (details will be posted tomorrow).
You will also have an opportunity to ask questions about anything we
have covered so far.  If you have questions you want answered, or topics
you'd like discussed, you can post them in the comments for these notes (or email me directly).</p>
</li>
</ul>
</div>

<p><center> 
<iframe src="//www.slideshare.net/slideshow/embed_code/44277798" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>
<div class="caption">Note: due to a bug in
slideshare's updated player, ink markings no longer appear in the
viewer.  <br>If you download the slides, they are present though.
Hopefully, the player will be fixed someday. </div>
</center></p>
<h1>Exploring Blocks</h1>
<table>
<thead>
<tr>
<th><strong>Label</strong></th>
<th align="left"><strong>Bytes</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>version</code></td>
<td align="left">4</td>
<td>Block version information</td>
</tr>
<tr>
<td><code>prev_block</code></td>
<td align="left">32</td>
<td>Hash of the previous block</td>
</tr>
<tr>
<td><code>merkle_root</code></td>
<td align="left">32</td>
<td>Hash of Merkle tree of all transactions</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td align="left">4</td>
<td>When block was created (overflows in 2106)</td>
</tr>
<tr>
<td><code>bits</code></td>
<td align="left">4</td>
<td>Difficulty target used for this block</td>
</tr>
<tr>
<td><code>nonce</code></td>
<td align="left">4</td>
<td>Nonce found to generate this block</td>
</tr>
</tbody>
</table>
<p><a href="http://blockexplorer.com/b/341537">Block 341537</a></p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="s2">&quot;000000000000000002b32e242989056214fef31c5aac08ae517840db3e3e7fd2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ver&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;prev_block&quot;</span><span class="o">:</span><span class="s2">&quot;000000000000000014a97984448f2b3e5b8582ece719be1a1ea7db1d1fce5561&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mrkl_root&quot;</span><span class="o">:</span><span class="s2">&quot;d634ceec0d9a8b065ad3203555b74877d0476e0b302972be41671a6b92a0a066&quot;</span><span class="p">,</span>
  <span class="s2">&quot;time&quot;</span><span class="o">:</span><span class="mi">1422830051</span><span class="p">,</span>
  <span class="s2">&quot;bits&quot;</span><span class="o">:</span><span class="mi">404399040</span><span class="p">,</span>
  <span class="s2">&quot;nonce&quot;</span><span class="o">:</span><span class="mi">527809407</span><span class="p">,</span>
  <span class="s2">&quot;n_tx&quot;</span><span class="o">:</span><span class="mi">1511</span><span class="p">,</span>
  <span class="s2">&quot;size&quot;</span><span class="o">:</span><span class="mi">760657</span><span class="p">,</span>
  <span class="s2">&quot;tx&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="s2">&quot;57db55dadb51ceeee6417af30946f234b2f77613e40586a2c03ce5e3a2be8bbb&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ver&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="p">...</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span><span class="mi">3533</span><span class="p">,</span>
      <span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;prev_out&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="s2">&quot;0000000000000000000000000000000000000000000000000000000000000000&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n&quot;</span><span class="o">:</span><span class="mi">4294967295</span>
          <span class="p">},</span> <span class="p">...</span>
      <span class="p">],</span>
      <span class="s2">&quot;out&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;1.00076629&quot;</span><span class="p">,</span> <span class="p">...</span>
   <span class="p">},</span>
   <span class="p">{</span>
      <span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="s2">&quot;675e40df163d5ae4556774b325cdd7b0885d552bf7989d5e24f7039fce315a5b&quot;</span><span class="p">,</span>
      <span class="p">...</span>
      <span class="s2">&quot;in&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;prev_out&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;hash&quot;</span><span class="o">:</span><span class="s2">&quot;04e9c75d42093094a486a1c898527f4b50e1788fe4fda3ecb2574662b75b6f90&quot;</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="s2">&quot;out&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;0.00100000&quot;</span><span class="p">,</span>
          <span class="s2">&quot;scriptPubKey&quot;</span><span class="o">:</span><span class="s2">&quot;OP_DUP OP_HASH160 9e21abc1748a1df63b4016ac313c0f88e557d5fd ...&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;0.00710182&quot;</span><span class="p">,</span>
          <span class="s2">&quot;scriptPubKey&quot;</span><span class="o">:</span><span class="s2">&quot;OP_DUP OP_HASH160 e37cd341540dd1e912568ae5b004d62422bd6b38 ...&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>     
    <span class="p">...</span>
  <span class="p">],</span>
  <span class="s2">&quot;mrkl_tree&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="s2">&quot;57db55dadb51ceeee6417af30946f234b2f77613e40586a2c03ce5e3a2be8bbb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;66a3eea4610dfb7d7987ad4fc22392c7964340d21006c1eea4c88174fd660c58&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;675e40df163d5ae4556774b325cdd7b0885d552bf7989d5e24f7039fce315a5b&quot;</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<!-- # Merkle's Puzzles

Ralph Merkle, [_Publishing a New Idea_](http://merkle.com/1974/).
Includes his [cs244 project
proposal](http://merkle.com/1974/FirstCS244projectProposal.pdf)
("Discussion: No, I am not joking.") and [ACM rejection
letter](http://merkle.com/1974/ExpertLetter.pdf) ("I am sorry to have to
inform you that the paper is not in the main stream of present
cryptography thinking and I would not recommend that it be
published...").

**Construction.**
-->

<h1>Merkle Trees</h1>
<p><a href="https://github.com/btcsuite/btcd/blob/master/blockchain/merkle.go">https://github.com/btcsuite/btcd/blob/master/blockchain/merkle.go</a> (some comments removed)</p>
<div class="highlight"><pre><span class="c1">// HashMerkleBranches takes two hashes, treated as the left and right tree</span>
<span class="c1">// nodes, and returns the hash of their concatenation. </span>
<span class="kd">func</span> <span class="nx">HashMerkleBranches</span><span class="p">(</span><span class="nx">left</span> <span class="o">*</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">ShaHash</span><span class="p">,</span> <span class="nx">right</span> <span class="o">*</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">ShaHash</span><span class="p">)</span> <span class="o">*</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">ShaHash</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">sha</span> <span class="p">[</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">HashSize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span><span class="kt">byte</span>
   <span class="nb">copy</span><span class="p">(</span><span class="nx">sha</span><span class="p">[:</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">HashSize</span><span class="p">],</span> <span class="nx">left</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
   <span class="nb">copy</span><span class="p">(</span><span class="nx">sha</span><span class="p">[</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">HashSize</span><span class="p">:],</span> <span class="nx">right</span><span class="p">.</span><span class="nx">Bytes</span><span class="p">())</span>
   <span class="nx">newSha</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">btcwire</span><span class="p">.</span><span class="nx">NewShaHash</span><span class="p">(</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">DoubleSha256</span><span class="p">(</span><span class="nx">sha</span><span class="p">[:]))</span>
   <span class="k">return</span> <span class="nx">newSha</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">BuildMerkleTreeStore</span><span class="p">(</span><span class="nx">transactions</span> <span class="p">[]</span><span class="o">*</span><span class="nx">btcutil</span><span class="p">.</span><span class="nx">Tx</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">ShaHash</span> <span class="p">{</span>
    <span class="nx">nextPoT</span> <span class="o">:=</span> <span class="nx">nextPowerOfTwo</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">transactions</span><span class="p">))</span>
    <span class="nx">arraySize</span> <span class="o">:=</span> <span class="nx">nextPoT</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nx">merkles</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">btcwire</span><span class="p">.</span><span class="nx">ShaHash</span><span class="p">,</span> <span class="nx">arraySize</span><span class="p">)</span>

    <span class="c1">// Create the base transaction shas and populate the array with them.</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tx</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">transactions</span> <span class="p">{</span> <span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">Sha</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// Start the array offset after the last transaction and adjusted to the</span>
    <span class="c1">// next power of two.</span>
    <span class="nx">offset</span> <span class="o">:=</span> <span class="nx">nextPoT</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">arraySize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">{</span>
           <span class="k">case</span> <span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span> 
              <span class="nx">merkles</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>

           <span class="k">case</span> <span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">:</span>
              <span class="nx">newSha</span> <span class="o">:=</span> <span class="nx">HashMerkleBranches</span><span class="p">(</span><span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
              <span class="nx">merkles</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="p">=</span> <span class="nx">newSha</span>

           <span class="k">default</span><span class="p">:</span>
              <span class="nx">newSha</span> <span class="o">:=</span> <span class="nx">HashMerkleBranches</span><span class="p">(</span><span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">merkles</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
              <span class="nx">merkles</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="p">=</span> <span class="nx">newSha</span>
       <span class="p">}</span>
       <span class="nx">offset</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">merkles</span>
<span class="p">}</span>
</pre></div>


<p><a href="/classes/class7/merkle.png"><img src="/classes/class7/merkle.png" width=600></a></p>
<p>What is needed to verify <span class="math">T<sub>2</sub></span> in <span class="math">H<sub>root</sub></span>?
<div class="gap"></p>
</div>

<p>What must be recomputed if <span class="math">T<sub>3</sub></span> is replaced?
<div class="gap"></p>
</div>

<p>What must be computed if a new node, <span class="math">T<sub>5</sub></span>, is added?
<div class="gap"></p>
</div>

<p>How many SHA-256 hashes must be computed to verify <a href="http://blockexplorer.com/b/341537">Block 341537</a>?
<div class="gap"></p>
</div></div>
<div class="commentstag"><a href="http://bitcoin-class.org/class-7-merkle-trees.html#disqus_thread" data-disqus-identifier="class-7-merkle-trees">Comments</a></div>
                   <hr />
        </div>

        <div class="article">
 
                   <h1><a href="http://bitcoin-class.org/class-6-proofs-of-work.html">Class 6: Proofs of Work</a></h1>
                   <div class="well small"><footer class="post-info">
<span class="quietlabel">Posted: </span>
<abbr class="published" title="2015-02-02T00:00:00-05:00">
    Mon 02 February 2015
</abbr>
<!-- <span class="quietlabel">by</span>
<a href="http://bitcoin-class.org/author/david-evans.html">David Evans</a>
-->
<!--
<span class="label">Category</span>
<a href="http://bitcoin-class.org/category/class6.html"><i class="icon-folder-open"></i>class6</a>.
-->

<!--
-->
</footer><!-- /.post-info --></div>
                   <div class="content"><p><div class="phighlight">
   <a href="http://bitcoin-class.org/classes/class6/class6.pdf">PDF version for printing</a>
   </div></p>
<h2>Schedule</h2>
<div class="todo">

<ul>
<li>
<p>If you didn’t get full credit for Project 1 because of failure to post
  something interesting, you can (and should!) redeem yourself and earn
  full credit by <strong>posting an interesting comment by Thursday</strong>.  It can
  be on (1) Discussion questions from Project 1 (2) notes from classes,
  or (3) general forum.</p>
</li>
<li>
<p><strong>Read:</strong> <a href="https://github.com/aantonop/bitcoinbook/blob/develop/ch06.asciidoc"><em>Chapter 6: The Bitcoin
Network</em></a>,
<a href="https://github.com/aantonop/bitcoinbook/blob/develop/ch07.asciidoc"><em>Chapter 7: The
Blockchain</em></a>
from Andreas Antonopoulos' book.  (Ideally, you should finish these
before Wednesday's class, but at the latest by Monday, 9 Feb.)
   </div></p>
</li>
</ul>
<p><center> 
<iframe src="//www.slideshare.net/slideshow/embed_code/44177245" width="476" height="400" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>
<div class="caption">Note: due to a bug in
slideshare's updated player, ink markings no longer appear in the
viewer.  <br>If you download the slides, they are present though.
Hopefully, the player will be fixed someday. </div>
</center></p>
<h1>Trust</h1>
<p>What are valid sources of <em>trust</em>?
<div class="gap"></p>
</div>

<p>What are invalid sources of <em>trust</em>?
<div class="gap"></p>
</div>

<p>What mechanisms have humans evolved or constructed to enhance trust among strangers?
<div class="gap"></p>
</div>

<h1>Distributed Consensus</h1>
<p>How well does the 2-out-of-3 network consensus public ledger protocol work?
<div class="gap"></p>
</div>

<h1>Proof-of-Work</h1>
<p>Cynthia Dwork and Moni Naor.  <a href="http://bitcoin-class.org/classes/class6/pvp.pdf"><em>Pricing via Processing or Combatting Junk Mail</em></a>, CRYPTO 1992.</p>
<p><strong>Pricing Function</strong>: (<span class="math"><em>f</em></span>)
- moderately easy to compute
- cannot be amortized 
- computing <span class="math"><em>f</em>(<em>m</em><sub>1</sub>), ..., <em>f</em>(<em>m</em><sub>l</sub>)</span> costs <span class="math"><em>l</em></span> times as much as computing <span class="math"><em>f</em>(<em>m</em><sub>i<sub>)</span>. 
- easily verified: given <span class="math"><em>x</em></span>, <span class="math"><em>y</em></span> easy to check <span class="math"><em>y</em> = <em>f</em>(<em>x</em>)</span>.</p>
<p>Adam Back. <a href="http://www.hashcash.org/papers/announce.txt"><em>Hash Cash Postage Implementation</em></a></p>
<p><strong>Interactive Hashcash</strong>:<br />
1. Sender to Receiver: <code>Hello</code><br />
2. Receiver to Sender: <span class="math"><em>r</em></span> (random nonce)<br />
3. Sender to Receiver: <span class="math"><em>x</em></span>, <code>Mail</code> where <span class="math"><em>x</em> = <em>f</em>(<em>r</em>)</span>.<br />
4. Receiver verifies <span class="math"><em>x</em> = <em>f</em>(<em>r</em>)</span>.  </p>
<p>How well does this protocol work for sending mail?
<div class="gap"></p>
</div>

<p>Suppose we use SHA-256 for <span class="math"><em>f</em></span>?
<div class="gap"></p>
</div>

<p>How can we make this protocol non-interactive?
<div class="gap"></p>
</div>

<h1>Bitcoin Mining</h1>
<p>Proof-of-work: Find an <span class="math"><em>x</em></span> such that: SHA-256(SHA-256(<span class="math"><em>r</em></span> + <span class="math"><em>x</em></span>)) &lt; <span class="math"><em>T</em>/<em>d</em></span>.</p>
<p><span class="math"><em>d</em></span> is the "difficulty" (varies).<br />
<span class="math"><em>T</em></span> is a fixed target (256-bit number).<br />
<span class="math"><em>r</em></span> depends on hash of previous block, transactions, and other information.</p>
<p>What does it mean for the bitcoin difficulty to go down?
<div class="gap"></p>
</div>

<p><a href="https://github.com/bitcoin/bitcoin/blob/master/src/miner.cpp">BitcoinMiner</a> (code from core Bitcoin implementation)</p>
<div class="highlight"><pre><span class="c1">//</span>
<span class="c1">// ScanHash scans nonces looking for a hash with at least some zero bits.</span>
<span class="c1">// The nonce is usually preserved between calls, but periodically or if the</span>
<span class="c1">// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at</span>
<span class="c1">// zero.</span>
<span class="c1">//</span>
<span class="kt">bool</span> <span class="k">static</span> <span class="nf">ScanHash</span><span class="p">(</span><span class="k">const</span> <span class="n">CBlockHeader</span> <span class="o">*</span><span class="n">pblock</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">&amp;</span> <span class="n">nNonce</span><span class="p">,</span> <span class="n">uint256</span> <span class="o">*</span><span class="n">phash</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Write the first 76 bytes of the block header to a double-SHA256 state.</span>
    <span class="n">CHash256</span> <span class="n">hasher</span><span class="p">;</span>
    <span class="n">CDataStream</span> <span class="n">ss</span><span class="p">(</span><span class="n">SER_NETWORK</span><span class="p">,</span> <span class="n">PROTOCOL_VERSION</span><span class="p">);</span>
    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">pblock</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">80</span><span class="p">);</span>
    <span class="n">hasher</span><span class="p">.</span><span class="n">Write</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">76</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">nNonce</span><span class="o">++</span><span class="p">;</span>

        <span class="c1">// Write the last 4 bytes of the block header (the nonce) to a copy of</span>
        <span class="c1">// the double-SHA256 state, and compute the result.</span>
        <span class="n">CHash256</span><span class="p">(</span><span class="n">hasher</span><span class="p">).</span><span class="n">Write</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nNonce</span><span class="p">,</span> <span class="mi">4</span><span class="p">).</span><span class="n">Finalize</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">phash</span><span class="p">);</span>

        <span class="c1">// Return the nonce if the hash has at least some zero bits,</span>
        <span class="c1">// caller will check if it has enough to reach the target</span>
        <span class="k">if</span> <span class="p">(((</span><span class="kt">uint16_t</span><span class="o">*</span><span class="p">)</span><span class="n">phash</span><span class="p">)[</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

        <span class="c1">// If nothing found after trying for a while, return -1</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">nNonce</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><a href="https://github.com/bitcoin/bitcoin/blob/master/src/miner.cpp#L438">BitcoinMiner</a>: (excerpted, most error checking code removed)</p>
<div class="highlight"><pre><span class="kt">void</span> <span class="k">static</span> <span class="nf">BitcoinMiner</span><span class="p">(</span><span class="n">CWallet</span> <span class="o">*</span><span class="n">pwallet</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">THREAD_PRIORITY_LOWEST</span><span class="p">);</span>
    <span class="n">CReserveKey</span> <span class="n">reservekey</span><span class="p">(</span><span class="n">pwallet</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nExtraNonce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">try</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Create new block</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nTransactionsUpdatedLast</span> <span class="o">=</span> <span class="n">mempool</span><span class="p">.</span><span class="n">GetTransactionsUpdated</span><span class="p">();</span>
            <span class="n">CBlockIndex</span><span class="o">*</span> <span class="n">pindexPrev</span> <span class="o">=</span> <span class="n">chainActive</span><span class="p">.</span><span class="n">Tip</span><span class="p">();</span>

            <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">CBlockTemplate</span><span class="o">&gt;</span> <span class="n">pblocktemplate</span><span class="p">(</span><span class="n">CreateNewBlockWithKey</span><span class="p">(</span><span class="n">reservekey</span><span class="p">));</span>
            <span class="n">CBlock</span> <span class="o">*</span><span class="n">pblock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pblocktemplate</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">;</span>
            <span class="n">IncrementExtraNonce</span><span class="p">(</span><span class="n">pblock</span><span class="p">,</span> <span class="n">pindexPrev</span><span class="p">,</span> <span class="n">nExtraNonce</span><span class="p">);</span>

            <span class="kt">int64_t</span> <span class="n">nStart</span> <span class="o">=</span> <span class="n">GetTime</span><span class="p">();</span>
            <span class="n">arith_uint256</span> <span class="n">hashTarget</span> <span class="o">=</span> <span class="n">arith_uint256</span><span class="p">().</span><span class="n">SetCompact</span><span class="p">(</span><span class="n">pblock</span><span class="o">-&gt;</span><span class="n">nBits</span><span class="p">);</span>
            <span class="n">uint256</span> <span class="n">hash</span><span class="p">;</span>
            <span class="kt">uint32_t</span> <span class="n">nNonce</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Check if something found</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ScanHash</span><span class="p">(</span><span class="n">pblock</span><span class="p">,</span> <span class="n">nNonce</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hash</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">UintToArith256</span><span class="p">(</span><span class="n">hash</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">hashTarget</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// Found a solution</span>
                        <span class="n">pblock</span><span class="o">-&gt;</span><span class="n">nNonce</span> <span class="o">=</span> <span class="n">nNonce</span><span class="p">;</span>
                        <span class="n">assert</span><span class="p">(</span><span class="n">hash</span> <span class="o">==</span> <span class="n">pblock</span><span class="o">-&gt;</span><span class="n">GetHash</span><span class="p">());</span>

                        <span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">THREAD_PRIORITY_NORMAL</span><span class="p">);</span>
                        <span class="n">LogPrintf</span><span class="p">(</span><span class="s">&quot;proof-of-work found  </span><span class="se">\n</span><span class="s">  hash: %s  </span><span class="se">\n</span><span class="s">target: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                              <span class="n">hash</span><span class="p">.</span><span class="n">GetHex</span><span class="p">(),</span> <span class="n">hashTarget</span><span class="p">.</span><span class="n">GetHex</span><span class="p">());</span>
                        <span class="n">ProcessBlockFound</span><span class="p">(</span><span class="n">pblock</span><span class="p">,</span> <span class="o">*</span><span class="n">pwallet</span><span class="p">,</span> <span class="n">reservekey</span><span class="p">);</span>
                        <span class="n">SetThreadPriority</span><span class="p">(</span><span class="n">THREAD_PRIORITY_LOWEST</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">nNonce</span> <span class="o">&gt;=</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
                <span class="c1">// ... other breaking conditions elided</span>
                <span class="c1">// Update nTime every few seconds</span>
                <span class="n">UpdateTime</span><span class="p">(</span><span class="n">pblock</span><span class="p">,</span> <span class="n">pindexPrev</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_interrupted</span><span class="o">&amp;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">LogPrintf</span><span class="p">(</span><span class="s">&quot;BitcoinMiner terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">throw</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
<div class="commentstag"><a href="http://bitcoin-class.org/class-6-proofs-of-work.html#disqus_thread" data-disqus-identifier="class-6-proofs-of-work">Comments</a></div>
                   <hr />
        </div>

        <div class="article">
 
                   <h1><a href="http://bitcoin-class.org/extra-office-hours.html">Extra Office Hours</a></h1>
                   <div class="well small"><footer class="post-info">
<span class="quietlabel">Posted: </span>
<abbr class="published" title="2015-01-29T00:00:00-05:00">
    Thu 29 January 2015
</abbr>
<!-- <span class="quietlabel">by</span>
<a href="http://bitcoin-class.org/author/david-evans.html">David Evans</a>
-->
<!--
<span class="label">Category</span>
<a href="http://bitcoin-class.org/category/announcements.html"><i class="icon-folder-open"></i>announcements</a>.
-->

<!--
-->
</footer><!-- /.post-info --></div>
                   <div class="content"><p><strong>Alex Kuck</strong> has offered to hold some extra office hours this evening
  to help out on Project 1.  You'll find him in the Rice Hall common
  area (the space next to the bagel shop) today, 5-7pm.</p></div>
<div class="commentstag"><a href="http://bitcoin-class.org/extra-office-hours.html#disqus_thread" data-disqus-identifier="extra-office-hours">Comments</a></div>
                   <hr />
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/class-5-digicash.html">Class 5: DigiCash</a> (Wed 28 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/class-5-digicash.html">More...</a>                      
                   </div>-->
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/class-4-verifiably-random.html">Class 4: Verifiably Random?</a> (Mon 26 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/class-4-verifiably-random.html">More...</a>                      
                   </div>-->
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/office-hours.html">Office Hours</a> (Sat 24 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/office-hours.html">More...</a>                      
                   </div>-->
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/communication-in-cryptocurrency-cafe.html">Communication in Cryptocurrency Cafe</a> (Fri 23 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/communication-in-cryptocurrency-cafe.html">More...</a>                      
                   </div>-->
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/key-chase.html">Key Chase</a> (Thu 22 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/key-chase.html">More...</a>                      
                   </div>-->
        </div>

        <div class="article">
                   <a href="http://bitcoin-class.org/class-3-elliptic-curves.html">Class 3: Elliptic Curves</a> (Wed 21 January 2015)<br></br>

 <!--                  <div class="summary">
                        <a class="btn primary xsmall" href="http://bitcoin-class.org/class-3-elliptic-curves.html">More...</a>                      
                   </div>-->
        </div>
        <hr />

        <div class="pagination">
        <ul>
                        <li class="prev disabled"><a href="#">&larr; Previous</a></li>
                        <li class="active"><a href="http://bitcoin-class.org/index.html">1</a></li>
                        <li class=""><a href="http://bitcoin-class.org/index2.html">2</a></li>
                        <li class="next"><a href="http://bitcoin-class.org/index2.html">Next &rarr;</a></li>
        </ul>
        </div>


<script type="text/javascript">
    var disqus_shortname = 'bitcoin-class';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
</script>

      <hr>

      <footer>
	<div id="footer">
        <address id="about">
          <a href="/">Cryptocurrency Cafe</a>, Spring 2015<br>      
          <a href="http://www.cs.virginia.edu">University of Virginia Computer Science</a><br>
	  <p align="right"><font color="grey" size="-2"> Site built using <a href="http://pelican.notmyidea.org/">Pelican</a>.  Theme uses <a href="http://twitter.github.com/bootstrap/">Bootstrap</a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome</a>.</p>
        </address><!-- /#about -->
	</div>
      </footer>

    </div><!--/.fluid-container-->


<script type="text/javascript">

var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-3775212-12']);
_gaq.push(['_setDomainName', 'bitcoin-class.org']);
_gaq.push(['_setAllowLinker', true]);
_gaq.push(['_trackPageview']);

(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript';
  ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
  'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(ga, s);
})();

</script>

    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://bitcoin-class.org/theme/js/jquery-1.7.2.min.js"></script>
    <script src="http://bitcoin-class.org/theme/js/bootstrap.min.js"></script>
  </body>
</html>